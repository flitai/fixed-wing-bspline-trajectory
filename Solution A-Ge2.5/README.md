# 固定翼无人机B样条轨迹生成器

本项目是一个基于C++实现的固定翼无人机（Fixed-Wing UAV）轨迹生成器。它根据一条稀疏的初始路径点，在包含障碍物的二维环境中，生成一条平滑、安全且满足动力学约束的三次B样条轨迹。

该算法的设计严格遵循了[《障碍环境下固定翼无人机B样条避障轨迹生成算法》](https://hill68.github.io/uas/trajectory_planning/-b-spline/%E9%9A%9C%E7%A2%8D%E7%8E%AF%E5%A2%83%E4%B8%8B%E5%9B%BA%E5%AE%9A%E7%BF%BC%E6%97%A0%E4%BA%BA%E6%9C%BAb-%E6%A0%B7%E6%9D%A1%E9%81%BF%E9%9A%9C%E8%BD%A8%E8%BF%B9%E7%94%9F%E6%88%90%E7%AE%97%E6%B3%95/index.html)文档中描述的流程，采用了“前端插值 + 后端优化”的层次化策略，以确保轨迹的质量和可行性。

## 核心特性

  * **平滑性**: 采用三次B样条曲线表示轨迹，保证了轨迹的二阶连续可导（$C^2$连续），并通过优化最小化加加速度（Jerk）来提升平滑度。
  * **安全避障**: 利用B样条的凸包特性，通过对控制点施加约束，确保整段轨迹都与障碍物保持安全距离。该过程依赖于预先计算的**距离场（Distance Field）**。
  * **动力学可行性**: 严格考虑固定翼无人机的物理限制，包括：
      * 最小/最大飞行速度
      * 最大向心加速度
      * 最小转弯半径（最大曲率）
  * **模块化设计**: 代码结构清晰，分为数据类型、B样条工具、轨迹优化器和主生成器等模块，方便集成到现有的无人机仿真平台或飞行控制系统中。
  * **可定制化**: 算法的关键参数，如无人机动力学参数、优化权重等，均可轻松配置，以适应不同的任务需求和飞行环境。

## 依赖项

在编译和运行本项目之前，请确保您的系统已安装以下软件：

1.  **CMake** (版本 3.10 或更高)
2.  **C++17 编译器** (如 GCC, Clang)
3.  **NLopt 库**: 一个开源的非线性优化库，是后端优化的核心依赖。
      * **Ubuntu/Debian**: `sudo apt-get install libnlopt-dev`
      * **macOS (Homebrew)**: `brew install nlopt`
      * **源码安装**: 访问 [NLopt 官方文档](https://nlopt.readthedocs.io/en/latest/)

## 编译与运行

**1. 克隆仓库**

```bash
git clone <your-repository-url>
cd <your-repository-name>
```

**2. 编译项目**
使用 CMake 进行编译：

```bash
mkdir build
cd build
cmake ..
make
```

**3. 运行示例**
编译成功后，在 `build` 目录下会生成一个名为 `trajectory_generator` 的可执行文件。

```bash
./trajectory_generator
```

程序将运行 `main.cpp` 中的示例代码，模拟一个简单的避障场景，并将生成的轨迹数据保存为 `final_trajectory.csv` 文件。您可以使用 Python (Matplotlib, Pandas)、MATLAB 等工具对该文件进行可视化分析。

## 算法流程

算法遵循“前端粗规划、后端精细优化”的思想，主要分为以下几个步骤：

### 1\. 前端：路径点插值与细化

  * **输入**:
      * 由A\*等路径搜索算法生成的稀疏初始路径点 `P`。
      * 二维障碍物栅格地图及其对应的距离场 `DF`。
      * 无人机动力学参数（速度、加速度、曲率限制）。
  * **过程**:
    1.  遍历初始路径的每一段 `(P_i, P_{i+1})`，根据该线段与最近障碍物的距离 `d_c` 和无人机最大速度 `v_max`，计算出允许的最大控制点间距 `r_max`。
    2.  如果段长 `l_i > r_max`，则在线段上进行等距线性插值，生成新的控制点，以确保B样条的凸包足够贴近原始路径，从而保证基础的安全性。
    3.  对插值后的控制点序列进行检查，合并距离过近的点（可能导致速度低于 `v_min`），为后端优化准备一个良好的初始值。

### 2\. 后端：非线性优化

此阶段是算法的核心，目标是调整内部自由控制点的位置，以生成一条最优轨迹。

  * **优化变量**: 除首尾各3个用于固定边界条件的控制点外，其余所有内部控制点 `Q_3, ..., Q_{M-3}`。
  * **成本函数**: 最小化一个加权组合成本函数 `J(Q)`。
  * **求解**: 使用 **NLopt** 库中的 L-BFGS (拟牛顿法) 算法求解此非线性优化问题，找到最优的控制点位置。

### 3\. 输出：离散化轨迹

  * **过程**:
    1.  使用优化后的控制点序列 `Q*` 构建最终的B样条曲线 `S*(t)`。
    2.  按照固定的时间间隔 `Δt` 对连续的B样条曲线进行采样，计算每个采样点的位置、速度和加速度。
    3.  对采样点进行最终的安全检查，确保所有动力学约束和避障要求都得到满足。
  * **输出**: 一系列带时间戳的状态点 `{S_k}`，可直接发送给无人机的轨迹跟踪控制器。

## 代码结构

```
.
├── CMakeLists.txt              # CMake 编译配置
├── README.md                   # 本文档
├── DataTypes.h                 # 定义所有核心数据结构 (Vector2D, UAVParams, etc.)
├── Bspline.h / .cpp            # B样条曲线类，封装求值和求导
├── TrajectoryOptimizer.h / .cpp # 后端优化器，定义成本函数并与NLopt交互
├── TrajectoryGenerator.h / .cpp # 算法主类，封装完整的生成流程
└── main.cpp                    # 一个完整的使用示例和测试入口
```

## 参数调整

您可以直接在 `main.cpp` 文件中修改以下参数，以观察它们对轨迹生成结果的影响：

  * **`uav_params`**: 无人机的动力学参数。例如，增大 `v_min` 或减小 `R_min`（即增大 `kappa_max`）会让规划问题更具挑战性。
  * **`bspline_params`**: B样条的基本参数，主要是时间间隔 `delta_t`。减小 `delta_t` 会产生更密集的轨迹点。
  * **`weights`**: 优化器中各项成本的权重。这是最重要的调试参数：
      * 增大 `weights.col` 会使轨迹更远离障碍物，但可能牺牲平滑度。
      * 增大 `weights.smooth` 会使轨迹更平滑，但可能在避障时不够灵活。
      * 增大 `weights.v`, `weights.a`, `weights.kappa` 会让优化器更严格地遵守相应的动力学约束。

通过调整这些权重，可以在轨迹的平滑性、安全性与动力学性能之间找到最佳平衡。

